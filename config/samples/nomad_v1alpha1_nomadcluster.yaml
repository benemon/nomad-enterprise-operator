apiVersion: nomad.hashicorp.com/v1alpha1
kind: NomadCluster
metadata:
  labels:
    app.kubernetes.io/name: nomad-enterprise-operator
    app.kubernetes.io/managed-by: kustomize
  name: nomad-enterprise
spec:
  replicas: 3
  image:
    repository: hashicorp/nomad
    tag: "1.11-ent"
  license:
    # Option 1: Reference an existing secret
    secretName: nomad-license
    secretKey: license
    # Option 2: Provide license inline (operator creates/manages secret)
    # value: "<your-license-content>"
  topology:
    region: global
    # datacenter defaults to namespace if empty
  services:
    external:
      type: LoadBalancer
      # loadBalancerIP: "10.0.0.100"  # Optional: request specific IP
  openshift:
    enabled: true
    route:
      enabled: true
      tls:
        termination: edge
        insecureEdgeTerminationPolicy: Redirect
    monitoring:
      enabled: true
      serviceMonitor:
        interval: 30s
        scrapeTimeout: 10s
      prometheusRule:
        enabled: true
  server:
    acl:
      enabled: true  # Auto-bootstrapped by operator
    tls:
      enabled: false
      # When enabled, provide certificates via:
      # Option 1: Reference an existing secret (ca.crt, server.crt, server.key)
      # secretName: nomad-tls
      # Option 2: Provide inline certificates (operator creates/manages secret)
      # caCert: |
      #   -----BEGIN CERTIFICATE-----
      #   ...
      #   -----END CERTIFICATE-----
      # serverCert: |
      #   -----BEGIN CERTIFICATE-----
      #   ...
      #   -----END CERTIFICATE-----
      # serverKey: |
      #   -----BEGIN RSA PRIVATE KEY-----
      #   ...
      #   -----END RSA PRIVATE KEY-----
    autopilot:
      cleanupDeadServers: true
      lastContactThreshold: "200ms"
      maxTrailingLogs: 250
      serverStabilizationTime: "10s"
    audit:
      enabled: true
      format: json
      rotateDuration: "24h"
      rotateMaxFiles: 15
    # Snapshot configuration (S3 bucket required when enabled)
    # snapshot:
    #   enabled: true
    #   interval: "1h"
    #   retain: 24
    #   s3:
    #     bucket: my-snapshot-bucket
    #     region: us-east-1
    #     endpoint: ""  # Optional: for S3-compatible storage
    #     forcePathStyle: true
    #     # Option 1: Reference an existing secret
    #     # credentialsSecretName: s3-credentials
    #     # Option 2: Provide credentials inline (operator creates/manages secret)
    #     # accessKeyId: "AKIAIOSFODNN7EXAMPLE"
    #     # secretAccessKey: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
    #     # Option 3: No credentials (uses IAM role/IRSA)
  persistence:
    enabled: true
    size: 10Gi
    audit:
      enabled: true
      size: 5Gi
  resources:
    limits:
      cpu: "2"
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 1Gi
  affinity:
    podAntiAffinity:
      enabled: true
      type: preferred
      weight: 100
      topologyKey: kubernetes.io/hostname
